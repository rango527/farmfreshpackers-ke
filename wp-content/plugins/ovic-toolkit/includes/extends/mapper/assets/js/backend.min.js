jQuery(function(e){"use strict";var t=function(){e(document).on("click",".ovic-mapper ul.nav li",function(t){e(this).addClass("active").siblings().removeClass("active");var i=e(this).parent().next(".tab-content").children('[data-tab="'+e(this).attr("data-nav")+'"]');i.length&&i.removeClass("hidden").siblings().addClass("hidden")}),e(document).on("click",".item-styled input",function(t){var i=e(this),a=i.val(),n=i.closest(".pin-setting");"link"==a?n.find('.nav li[data-nav="popup-settings"]').hide():n.find('.nav li[data-nav="popup-settings"]').show()})},i=function(){e(document).on("click",".ovic-mapper a.btn-add-image, .ovic-mapper #change-image, .ovic-mapper a.image-selector",function(t){t.preventDefault(),window.wr_image_selector||(window.wr_image_selector=wp.media({button:{text:ovic_mapper.text.img_selector_btn_label},states:[new wp.media.controller.Library({title:ovic_mapper.text.img_selector_modal_title,library:wp.media.query({type:"image"}),multiple:!1,date:!1})]}),window.wr_image_selector.on("select",function(){var t=window.wr_image_selector.state().get("selection").first();if("ovic_mapper_image"==window.wr_image_selector.input_element.attr("id"))if(window.wr_image_selector.input_element.val(t.attributes.id),e(".ovic-mapper-bot > .edit-image").length)e(".ovic-mapper-bot .image-wrap > img").attr("src",t.attributes.url);else{var i=e("#ovic_mapper_image_tmpl").text().replace("%URL%",t.attributes.url);e(".ovic-mapper-bot > .add-image").replaceWith(i),setTimeout(function(){e(document).trigger("init_ovic_mapper")},500)}else window.wr_image_selector.input_element.val(t.attributes.url).trigger("change");window.wr_image_selector.close()})),window.wr_image_selector.input_element=e(this).hasClass("image-selector")?e(this).prev("input"):e("#ovic_mapper_image"),window.wr_image_selector.open()})},a=function(){var t=Backbone.Model.extend({defaults:function(){return{top:0,left:0,settings:{}}}}),i=Backbone.Collection.extend({model:t,url:"#",fetch:function(){window.ovic_mapper_pins&&window.ovic_mapper_pins.length&&this.add(window.ovic_mapper_pins)}}),a=new i,n=0,s=Backbone.View.extend({tagName:"div",className:"ovic-pin",template:_.template(e("#ovic_mapper_pin_tmpl").text()),events:{"click .icon-pin":"edit","click .icon-pin + img":"edit","click .text__area":"edit","click .close-box":"close","click .pin-action.delete-pin":"remove","click .pin-action.duplicate-pin":"clone"},initialize:function(){this.index=n++},render:function(){var t=this,i=this.model.get("settings");this.$el.addClass(this.className).html(this.template(this.model.toJSON()));var a=this.model.get("top"),n=this.model.get("left");return("number"==typeof a||"%"!=a.substr(-1))&&(a=a/e(".image-wrap").height()*100+"%",this.model.set("top",a)),("number"==typeof n||"%"!=n.substr(-1))&&(n=n/e(".image-wrap").width()*100+"%",this.model.set("left",n)),this.$el.css({top:a,left:n}),this.$el.draggable({stop:function(i,a){var n=a.position.top/e(".image-wrap").height()*100+"%",s=a.position.left/e(".image-wrap").width()*100+"%";t.model.set("top",n),t.model.set("left",s),t.$el.find('[data-option="top"]').val(n),t.$el.find('[data-option="left"]').val(s),t.$el.css({top:n,left:s}),t.just_dragged=!0,setTimeout(function(){t.just_dragged=!1},200)}}).css("position","absolute"),i["pin-type"]&&"woocommerce"!=i["pin-type"]||this.$el.find(".tooltip").addClass("hidden"),"link"==i["pin-type"]&&this.$el.find('.nav li[data-nav="popup-settings"]').hide(),this.$el.find("[data-option]").each(function(){var a=e(this).attr("data-option").match(/([^\[]+)(\[([^\[]+)\])*/);e(this).attr("name")!=a[0]&&(void 0!==a[3]?e(this).attr("name","ovic_mapper_pins["+t.index+"]["+a[1]+"]["+a[3]+"]"):e(this).attr("name","ovic_mapper_pins["+t.index+"]["+a[1]+"]"));var n;switch(void 0!==a[3]?i[a[3]]&&(n=i[a[3]]):n=t.model.get(a[1]),n&&("INPUT"==e(this).prop("nodeName")?"radio"==e(this).attr("type")?e(this).attr("value")==n?e(this).attr("checked","checked"):e(this).removeAttr("checked"):(e(this).val(n),"hidden"==e(this).attr("type")&&"checkbox"==e(this).next().attr("type")&&(parseInt(n)?e(this).next().attr("checked","checked"):e(this).next().removeAttr("checked"))):"TEXTAREA"==e(this).prop("nodeName")?e(this).val(n.replace(/<br>/g,"\n")):e(this).val(n)),e(this).attr("data-option")){case"settings[popup-width]":case"settings[popup-height]":var s=e(this).attr("data-option").match(/settings\[([^\]]+)\]/);e(this).attr("placeholder",e('#general-settings [name*="'+s[1]+'"]').val());break;case"settings[area-text]":e(this).keyup(function(){0==e(this).val().length&&t.$el.find(".text__area").empty(),""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").html(e(this).val())}).trigger("keyup"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-text-size]":e(this).keyup(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").css("font-size",e(this).val()+"px")}).trigger("keyup"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-text-color]":e(this).change(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").css("color",e(this).val()+"px")}).trigger("change"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-width]":e(this).keyup(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").css("width",e(this).val()+"px")}).trigger("keyup"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-height]":e(this).keyup(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&(t.$el.find(".text__area").css("height",e(this).val()+"px"),t.$el.find(".text__area").css("line-height",e(this).val()+"px"))}).trigger("keyup"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-border-width]":e(this).keyup(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").css({"border-width":e(this).val()+"px","border-style":"solid"})}).trigger("keyup"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-border-radius]":e(this).keyup(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").css("border-radius",e(this).val()+"px")}).trigger("keyup"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-bg-color]":e(this).change(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").css("background",e(this).val())}).trigger("change"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[area-border-color]":e(this).change(function(){""!=e(this).val()&&"icon-area"==t.$el.find('[data-option*="icon-type"]:checked').val()&&t.$el.find(".text__area").css("border-color",e(this).val())}).trigger("change"),t.$el.find(".icon-pin").next().next("div.text__area").removeClass("hidden");break;case"settings[image-template]":e(this).change(function(){if(""!=e(this).val()&&"icon-image"==t.$el.find('[data-option*="icon-type"]:checked').val()){var i=t.$el.find(".icon-pin").addClass("hidden");i.next("img").attr("src")!=e(this).val()&&i.next("img").attr("src",e(this).val()),i.next("img").removeClass("hidden")}}).trigger("change");break;case"settings[icon-type]":e(this).change(function(){if(e(this).attr("checked")){var i=t.$el.find(".icon-pin"),a=t.$el.find(".text__area"),n=t.$el.find("img"),s=t.$el.find('[data-icon-type="'+e(this).val()+'"]');"icon-font"==e(this).val()?i.removeClass("hidden").next("img").addClass("hidden"):"icon-area"==e(this).val()?(i.addClass("hidden"),n.addClass("hidden"),a.removeClass("hidden")):(i.next("img").length||i.after('<img class="hidden">'),a.addClass("hidden")),s.find("input, select, textarea").trigger("change").trigger("keyup")}}).trigger("change")}e(this).hasClass("color-picker")?(e(this).cs_wpColorPicker(),setTimeout(e.proxy(function(){e(this).parent().parent().click(function(){e(".ovic-mapper .icon-selector").each(function(){"none"==e(this).children(".icon-wrap").css("display")||e.contains(this,event.target)||e(this).children(".icon-wrap").hide()})})},this),500)):e(this).hasClass("icon-selector")?(""==e(this).val()&&e(this).val("fa-plus"),e(this).addClass("hidden").after(e("#ovic_mapper_icon_selector_tmpl").text().replace("%SELECTED%",e(this).val()))):e(this).hasClass("product-selector")&&e(this).select2({minimumInputLength:1,ajax:{url:ovic_mapper.product_selector.url,dataType:"json",delay:250,data:function(e){return{term:e,security:ovic_mapper.product_selector.security}},results:function(e){var t=[];for(var i in e)t.push({id:i,text:e[i].replace("&ndash;"," - ")});return{results:t}}},initSelection:function(t,i){var a=e(t).val();""!==a&&e.ajax(ovic_mapper.product_selector.url+"&term="+a+"&security="+ovic_mapper.product_selector.security,{dataType:"json"}).done(function(e){i({id:a,text:e[a].replace("&ndash;"," - ")})})}})}),this.$el.on("click",".icon-selected",function(){e(this).next().toggle()}).on("click",".icon-wrap .close",function(){e(this).parent().parent().hide()}).on("click",".ovic-icon-list a",function(t){t.preventDefault();var i=e(this).closest(".icon-wrap").prev().children();i.attr("class",i.attr("class").replace(/fa-.+/,e(this).attr("data-value"))),e(this).closest(".icon-selector").prev().val(e(this).attr("data-value")).trigger("change")}),this},edit:function(t){if(e(t.target).parent().hasClass("ovic-pin")&&!this.just_dragged)if(this.$el.hasClass("editing"))this.close(t);else{if(!this.$el.data("ovic_mapper_pin_settings_initialized")){var i=this;this.$el.on("change",'input[type="radio"], select',function(){if(e(this).attr("data-option")){var t=e(this).attr("data-option").match(/([^\[]+)(\[([^\[]+)\])*/),a=e(this).val();t[3]&&i.$el.find("[data-"+t[3]+"]").each(function(){e(this).attr("data-"+t[3]).indexOf(a)>-1?e(this).removeClass("hidden"):e(this).addClass("hidden")})}}).find('input[type="radio"]:checked, select').trigger("change"),this.$el.data("ovic_mapper_pin_settings_initialized",!0)}this.$el.draggable("option","disabled",!0),this.$el.addClass("editing");var a=this.$el.children(".pin-setting");if("auto"==a.css("top")){var n=this.$el.height();a.offset().top+a.height()>e(window).height()&&(n+=e(window).height()-(a.offset().top+a.height()),n-=parseInt(a.css("border-top-width"))+parseInt(a.css("border-bottom-width"))),a.css("top",n+"px")}if("auto"==a.css("left")){var s=0;a.offset().left+a.width()>e(window).width()&&(s+=e(window).width()-(a.offset().left+a.width()),s-=parseInt(a.css("border-left-width"))+parseInt(a.css("border-right-width"))),a.css("left",s+"px")}a.draggable()}},close:function(e){this.$el.children(".pin-setting").draggable("destroy"),this.$el.removeClass("editing");var t=this.$el.find('input[data-option*="pin-type"]:checked').val();if("woocommerce"==t)this.$el.find(".tooltip").addClass("hidden");else{var i=this.$el.find('input[data-option*="popup-title"]').val();this.$el.find(".tooltip").text(i?i:ovic_mapper.text.please_input_a_title).removeClass("hidden")}this.$el.draggable("option","disabled",!1)},remove:function(t){t.preventDefault(),confirm(ovic_mapper.text.confirm_removing_pin)&&(this.$el.remove(),this.model.destroy(),e("#post #publish").attr("data-changed","yes"))},clone:function(t){if(t.preventDefault(),!this.just_cloned){var i={};this.$el.children(".pin-setting").find("input, select, textarea").each(function(t,a){if(e(a).attr("data-option")){var n=e(a).attr("data-option").match(/([^\[]+)(\[([^\[]+)\])*/);void 0!==n[3]&&("INPUT"==a.nodeName&&("checkbox"==a.type||"radio"==a.type)?a.checked&&(i[n[3]]=e(a).val()):i[n[3]]=e(a).val())}}),i.id="",a.add([{top:parseInt(this.model.get("top"))+1+"%",left:parseInt(this.model.get("left"))+1+"%",settings:i}]);var n=this;n.just_cloned=!0,setTimeout(function(){n.just_cloned=!1},200)}}}),o=Backbone.View.extend({el:".ovic-mapper-bot > .edit-image > .image-wrap",initialize:function(){this.listenTo(a,"add",this.addOne),e(document).on("click",".ovic-mapper-bot > .edit-image > .image-wrap > img",this.create),a.fetch()},addOne:function(e){var t=new s({model:e}),i=t.render().el;this.$el.append(i)},create:function(t){e(".ovic-pin.editing").length||(a.add([{top:t.clientY-e(t.target).offset().top+e(window).scrollTop()-12,left:t.clientX-e(t.target).offset().left+e(window).scrollLeft()-12}]),e("#post #publish").attr("data-changed","yes"))}});e(document).on("init_ovic_mapper",function(t){if(!e(document).data("ovic_mapper_settings_initialized")){e("#general-settings > a").click(function(){e(this).parent().toggleClass("editing");var t=e(this).next();if("auto"==t.css("top")||0===parseInt(t.css("top"))){var i=e(this).parent().height();t.offset().top+t.height()>e(window).height()&&(i+=e(window).height()-(t.offset().top+t.height()),i-=parseInt(t.css("border-top-width"))+parseInt(t.css("border-bottom-width"))),t.css("top",i+"px")}if("auto"==t.css("left")||0===parseInt(t.css("left"))){var a=0;t.offset().left+t.width()>e(window).width()&&(a+=e(window).width()-(t.offset().left+t.width()),a-=parseInt(t.css("border-left-width"))+parseInt(t.css("border-right-width"))),t.css("left",a+"px")}}),e("#general-settings > div").draggable().css("position","absolute").on("click",".close-box",function(){e("#general-settings").removeClass("editing")}),e("#general-settings").find("input, select, textarea").each(function(){window.ovic_mapper_settings[e(this).attr("name")]&&(e(this).val(window.ovic_mapper_settings[e(this).attr("name")]),"hidden"==e(this).attr("type")&&"checkbox"==e(this).next().attr("type")&&(parseInt(window.ovic_mapper_settings[e(this).attr("name")])?e(this).next().attr("checked","checked"):e(this).next().removeAttr("checked"))),e(this).attr("name","ovic_mapper_settings["+e(this).attr("name")+"]"),e(this).hasClass("color-picker")&&(e(this).cs_wpColorPicker(),setTimeout(e.proxy(function(){e(this).parent().parent().click(function(){e(".ovic-mapper .icon-selector").each(function(){"none"==e(this).children(".icon-wrap").css("display")||e.contains(this,t.target)||e(this).children(".icon-wrap").hide()})})},this),500))}),e("#general-settings").on("change",'input[type="radio"], select',function(){var t=e(this).attr("name").match(/ovic_mapper_settings\[([^\]]+)\]/),i=e(this).val();t[1]&&e("#general-settings").find("[data-"+t[1]+"]").each(function(){e(this).attr("data-"+t[1]).indexOf(i)>-1?e(this).removeClass("hidden"):e(this).addClass("hidden")})}).find('input[type="radio"]:checked, select').trigger("change"),e(document).click(function(t){e(t.target).closest(".media-modal").length||(e(".ovic-mapper .wp-picker-holder .iris-picker").each(function(){"none"==e(this).css("display")||e.contains(this,t.target)||e(this).parent().children().hide()}),e(".ovic-mapper .icon-selector").each(function(){"none"==e(this).children(".icon-wrap").css("display")||e.contains(this,t.target)||e(this).children(".icon-wrap").hide()}),e("#general-settings.editing, .ovic-pin.editing").each(function(){e.contains(this,t.target)||e(this).find(".close-box").trigger("click")}))});var i=".ovic-mapper input, .ovic-mapper select, .ovic-mapper textarea";e(document).on("change",i,function(){e(this).attr("name")&&e(this).attr("name").indexOf("ovic_mapper_")>-1&&e("#post #publish").attr("data-changed","yes")}),e("#post #publish").click(function(){e(this).removeAttr("data-changed"),e(window).off("beforeunload").unbind("beforeunload")}),e(window).on("beforeunload",function(){var t=e("#post #publish");return t.length&&"yes"==t.attr("data-changed")?ovic_mapper.text.ask_for_saving_changes:void 0}),e(document).data("ovic_mapper_settings_initialized",!0)}!window.ovic_mapper_pins_app&&e(".ovic-mapper-bot > .edit-image > .image-wrap").length&&(window.ovic_mapper_pins_app=new o)})};e(document).ready(function(){t(),i(),a()})});